name: Provision EC2 + Deploy Node App

on:
  workflow_dispatch:

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
        aws --version

    - name: Configure AWS Credentials
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set default.region us-east-1

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Generate SSH Key Pair
      run: |
        ssh-keygen -t rsa -b 4096 -f ec2_key -N ""
        echo "SSH_PRIVATE_KEY<<EOF" >> $GITHUB_ENV
        cat ec2_key >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "SSH_PUBLIC_KEY=$(cat ec2_key.pub)" >> $GITHUB_ENV

    - name: Replace Public Key in terraform.tfvars
      run: |
        echo "public_key_path = \"./ec2_key.pub\"" >> terraform/terraform.auto.tfvars

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply (Provision EC2)
      working-directory: terraform
      run: terraform apply -auto-approve

    - name: Get EC2 Public IP
      id: get_ip
      working-directory: terraform
      run: |
        echo "EC2_IP=$(terraform output -raw public_ip)" >> $GITHUB_ENV
        echo "::set-output name=ec2_ip::$(terraform output -raw public_ip)"

    - name: Wait for SSH to be ready
      run: |
        echo "Waiting for EC2 to be reachable..."
        for i in {1..15}; do
          if nc -zv ${{ env.EC2_IP }} 22; then echo "EC2 ready!"; break; fi
          sleep 10
        done

    - name: Copy project files to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ env.EC2_IP }}
        username: ubuntu
        key: ${{ env.SSH_PRIVATE_KEY }}
        source: "."
        target: "~/app"

    - name: Deploy App in Docker on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_IP }}
        username: ubuntu
        key: ${{ env.SSH_PRIVATE_KEY }}
        script: |
          cd ~/app
          sudo docker stop node-app || true
          sudo docker rm node-app || true
          sudo docker build -t node-app .
          sudo docker run -d --env-file .env -p 3000:3000 --name node-app node-app
